{% extends 'base.html' %}

{% load staticfiles %}

{% block body_block %}

    <script>
        last_message_id = -1;

        function get_messages(){
            message_text_area = document.getElementById("message_text_area");
            $.get('/game/get_messages/',{'last_message_id':last_message_id,'to_account_id':{{enemy_city.account.pk}}}, function(data){

                messages = data.split('$$');
                for(i=0; i < messages.length; i++){
                    if(messages[i] != ""){
                        real_message = messages[i].split('||');
                        message_id = parseInt(real_message[0]);
                        if(message_id>last_message_id){
                            last_message_id=message_id;
                        }
                        message_text_area.value += real_message[1]+': '+real_message[2]+'\n'
                        message_text_area.scrollTop = message_text_area.scrollHeight;
                    }
                }
            });
        }

        function sendMessage() {
            var x = document.getElementById("user_msg").value;
            $.get('/game/add_message/', {'message': x,'to_account_id':{{enemy_city.account.pk}}}, function(data){
                if(data == -1){
                    $('#notif_span').html("Message was not delivered");
                    $("#notif_alert").show();
                }else{
                    document.getElementById("user_msg").value="";
                    get_messages();
                }
            });
        }

        $(document).ready(function(){
            document.getElementById("message_text_area").readOnly=true;
            $('#sendButton').click(function(){
                sendMessage();
            });

            $('#user_msg').keyup(function(event){
                if(event.keyCode == 13){
                    $("#sendButton").click();
                }
            });

            $('.alert .close').on('click', function(e) {
                $(this).parent().hide();
            });

            //polling that gets the messages
            get_messages();
            setInterval(function() {get_messages()}, 1000);
        });

    </script>


{% if user.is_authenticated %}
<div class="container">
    <div class="row">
        <div class="col-md-2 text-center">
            <h1>{{city.account.user.username}}</h1>

            <div class="row">
                <img src="{{ MEDIA_URL }}/media/{{city.account.picture}}" %}" width=90% class="img-thumbnail"/>
            </div>
            <div class="row">
                <li><strong>Supply Capacity: </strong><span
                        id="maximumTroops">{{city.get_maximum_troops}}</span></li>
                <li><strong>Walls Level: </strong><span
                        id="maximumTroops">{{city.walls_level}}</span></li>
                <li><strong>Footmen: </strong><span
                        id="maximumTroops">{{city.footmen}}</span></li>
                <li><strong>Bowmen: </strong><span
                        id="maximumTroops">{{city.bowmen}}</span></li>
                <li><strong>Knights: </strong><span
                        id="maximumTroops">{{city.knights}}</span></li>
                <li><strong>War Machines: </strong><span
                        id="maximumTroops">{{city.war_machines}}</span></li>
                <li><strong>Army Total: </strong><span
                        id="maximumTroops">{{city.army_total}}</span></li>
            </div>
        </div>
        <div class="col-md-8 text-center">
            <h1>VS</h1>
            <img src="{% static "images/siege.jpg" %}" width=90% class="img-thumbnail" />
        </div>

        <div class="col-md-2">
            <div class="text-center">
                <h1>{{enemy_city.account.user.username}}</h1>
                <div class="row">
                    <img src="{{ MEDIA_URL }}/media/{{enemy_city.account.picture}}" %}" width=90%
                    class="img-thumbnail"/>
                </div>
                <div class="row">
                    <li><strong>Supply Capacity: </strong><span
                            id="maximumTroops">{{city.get_maximum_troops}}</span></li>
                    <li><strong>Walls Level: </strong><span
                            id="maximumTroops">{{city.walls_level}}</span></li>
                </div>
            </div>
            <div class="row">
                <label for="message_text_area" id="message_chat_heading">Chat</label>
            </div>
            <div class="row">
                    <textarea id="message_text_area"
                              style="min-width: 100%; height: 100px; max-height: 100px;"></textarea>
            </div>
            <div class="row">
                <input type="text" id="user_msg">
                <button id="sendButton" class="btn btn-default" type="button">Send</button>
            </div>
            <div class="row">
                <div class="alert fade in alert-danger" id="notif_alert" style="display:none;">
                    <button type="button" class="close">x</button>
                    <strong><span id="notif_span"></span></strong>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12 text-center">
            <div class="row">
                <button id="attackButton" type="button">Attack</button>
            </div>
            <div class="row">
                <label for="logs_text" id="LogsHeading">Battle Results</label>
                <textarea id="logs_text" style="min-width: 100%; height: 100px; max-height: 100px;"></textarea>
            </div>
            <div class="row">
                <a href="/game/">to City</a><br/>
            </div>

            <div class="row">
                <a href="/game/logout/">Logout</a><br/>
            </div>

            {% else %}
            <a href="/game/register/">Register Here</a><br/>
            <a href="/game/login/">Login</a><br/>
            {% endif %}

        </div>
    </div>


{% endblock %}