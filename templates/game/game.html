<!DOCTYPE html>
{% load staticfiles %} <!-- New line -->

<html lang="en">
<head>
    <title>Rulers of The Kingdom</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <style>
    </style>
    <script>
        latest_log_id = -1;

        function populateLogBox(){
            logs_text_area = document.getElementById("logs_text");
            $.get('/game/get_logs/',{'latest_log_id':latest_log_id}, function(data){

                logs = data.split('$$');
                for(i=0; i < logs.length; i++){
                    if(logs[i] != ""){
                        real_log = logs[i].split('||');
                        log_id = parseInt(real_log[0]);
                        if(log_id>latest_log_id){
                            latest_log_id=log_id;
                        }
                        logs_text_area.value += real_log[1]+': '+real_log[2]+'\n'
                        logs_text_area.scrollTop = logs_text_area.scrollHeight;
                    }
                }
            });
        }

        function updateGold(){
            $.get('/game/get_gold/', function(data){
                $('#goldSpan').html(data);
            });
        }

		$(document).ready(function(){
		    document.getElementById("logs_text").readOnly = true;

            $('#houseButton,#wallButton,#footmenButton,#knightsButton,#bowmenButton,#war_machinesButton,#landsButton').click(function(){
                et = $(this).attr("element_type");
                $.get('/game/buy', {element_type: et}, function(data){
                    if(data == "-1"){
                        //show alert
                        $("#alertNoGold").show();
                    }else if (data=="-3"){
                    	//show alert
                        $("#alertInsufficientMaxTroops").show();
                    }else {
                       //increments stuff
                       switch(et){
                           case "house":
                                var res = data.split(",");
                                $('#houseLevel').html(res[0]);
                                $('#maximumTroops').html(res[1]);
                                $('#houseCost').html(res[2]);
                                try {
                                    $.get('/game/city_img/'+res[0], function(data){
                                        if(data!=-1){
                                            document.getElementById("cityImg").src = data;
                                        }
                                    });
                                }
                                catch(err) {
                                    console.log(err.message);
                                }
                                break;
                           case "wall":
                                var res = data.split(",");
                                $('#wallLevel').html(res[0]);
                                $('#wallCost').html(res[1]);
                                break;
                           case "lands":
                                var res = data.split(",");
                                $('#lands_owned').html(res[0]);
                                $('#lands_owned_cost').html(res[1]);
                                break;
                           case "knights":
                                $('#knights').html(data);
                                break;
                           case "footmen":
                                $('#footmen').html(data);
                                break;
                           case "bowmen":
                                $('#bowmen').html(data);
                                break;
                           case "knights":
                                $('#knights').html(data);
                                break;
                           case "war_machines":
                                $('#war_machines').html(data);
                                break;
                       }
                       updateGold();
                   }
                 });
            });

            $('#createAllianceButton').click(function(){
                name=document.getElementById("createAllianceName").value;
                desc=document.getElementById("createDescName").value;
                $.get('/game/create_alliance', {'name': name,'desc':desc}, function(data){
                    if(data ==1){
                        window.location.href = "/game/";
                    }else{
                        console.log(data);
                    }
                });
            });


            // when alert close
            $('.alert .close').on('click', function(e) {
                $(this).parent().hide();
            });

            //polling that gets the logs
            populateLogBox()
            setInterval(function() {populateLogBox()}, 5000);
        });




    </script>

</head>
<body>
{% if user.is_authenticated %}

<div class="container">

    <div>
        <img src="{% static "images/banner.png" %}" width=80% class="img-responsive" />
        <div>

            <div class="row">
                <h2><strong>Lord {{acc.user}} - {{city.name}}</strong></h2>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="row">
                        <table class="table table-bordered">
                            <thead>
                            <tr>
                                <th>Structures</th>
                                <th>Level</th>
                                <th>Upgrade Cost</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td style="width:5%">Supply Level</td>
                                <td style="width:5%"><span id="houseLevel">{{city.house_level}}</span></td>
                                <td style="width:5%"><span id="houseCost">{{cost.house_price}}</span>
                                    <button id="houseButton" element_type="house" type="button">+</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">Walls Level</td>
                                <td style="width:5%"><span id="wallLevel">{{city.walls_level}}</span></td>
                                <td style="width:5%"><span id="wallCost">{{cost.wall_price}}</span>
                                    <button id="wallButton" element_type="wall" type="button">+</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">Lands Owned</td>
                                <td style="width:5%"><span id="lands_owned">{{city.lands_owned}}</span></td>
                                <td style="width:5%"><span id="lands_owned_cost">{{cost.lands_price}}</span>
                                    <button id="landsButton" element_type="lands" type="button">+</button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="row">
                        <table class="table table-bordered">
                            <thead>
                            <tr>
                                <th>Troop Type</th>
                                <th>Amount</th>
                                <th>Hiring Cost</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td style="width:5%">Footmen</td>
                                <td style="width:5%"><span id="footmen">{{city.footmen}}</span></td>
                                <td style="width:5%">{{cost.footmen_price}}
                                    <button id="footmenButton" element_type="footmen" type="button">+</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">Knights</td>
                                <td style="width:5%"><span id="knights">{{city.knights}}</span></td>
                                <td style="width:5%">{{cost.knights_price}}
                                    <button id="knightsButton" element_type="knights" type="button">+</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">Bowmen</td>
                                <td style="width:5%"><span id="bowmen">{{city.bowmen}}</span></td>
                                <td style="width:5%">{{cost.bowmen_price}}
                                    <button id="bowmenButton" element_type="bowmen" type="button">+</button>
                                </td>
                            </tr>
                            <tr>
                                <td style="width:5%">WarMachines</td>
                                <td style="width:5%"><span id="war_machines">{{city.war_machines}}</span></td>
                                <td style="width:5%">{{cost.war_machines_price}}
                                    <button id="war_machinesButton" element_type="war_machines" type="button">+</button>
                                </td>
                            </tr>
                            </tbody>

                        </table>
                    </div>
                </div>
                <div class="col-md-6">
                    <img id="cityImg" src="/{{ city_pic.picture}}" width=100% class="img-thumbnail"/>
                </div>
                <div class="col-md-2">
                    <div class="row">
                        <img src="{{ MEDIA_URL }}/media/{{acc.picture}}" %}" width=90% class="img-thumbnail"/>
                    </div>
                    <div class="row">
                        <strong>Supply Capacity: </strong><span
                            id="maximumTroops">{{city.get_maximum_troops}}</span></br>
                        <strong>Gold: </strong><span id="goldSpan">{{city.gold}}</span>
                    </div>
                    <div class="row">
                        {% if acc.alliance %}
                        {% if acc.alliance_owner %}
                        <strong>Leader of: </strong>
                        {% else %}
                        <strong>Member of: </strong>
                        {% endif %}
                        <a href="/game/alliance/{{acc.alliance.name}}">{{acc.alliance.name}}</a><br/>
                        {% else %}
                        <strong><a href="javascript:$('#createAllianceStep').show();">Create</a> or <a
                                href="/game/alliance_search/">Join</a> an alliance</strong>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="alert fade in alert-success" id="createAllianceStep" style="display:none;">
                            <button type="button" class="close">×</button>
                            <div class="input-group">
                                <input id="createAllianceName" type="text" class="form-control"
                                       placeholder="Alliance Name...">
                                <input id="createDescName" type="text" class="form-control"
                                       placeholder="Description...">
                                <button id="createAllianceButton" class="btn btn-default" type="button">Create!</button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="list-group">
                            <a class="list-group-item active">
                                Opponents
                            </a>
                            {% for acc in userlist %}
                            <li><a href="/game/battle/{{acc.user.username}}">{{acc.user.username}} </a></li>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert fade in alert-danger" id="alertNoGold" style="display:none;">
                <button type="button" class="close">×</button>
                <strong>Not enough gold!</strong>
            </div>

            <div class="alert fade in alert-danger" id="alertInsufficientMaxTroops" style="display:none;">
                <button type="button" class="close">×</button>
                <strong>Insufficient supplies!</strong>
            </div>

            <div class="row">
                <div class="row">
                    <label for="logs_text" id="LogsHeading">Account Logs</label>
                </div>
                <div class="row">
                    <textarea id="logs_text"
                        style="min-width: 100%; height: 100px; max-height: 100px;"></textarea>
                </div>
            </div>


            <div class="row">
                <a href="/game/logout/">Logout</a><br/>
            </div>
        </div>

        {% else %}
        <a href="/game/register/">Register Here</a><br/>
        <a href="/game/login/">Login</a><br/>
        {% endif %}

</body>
</html>